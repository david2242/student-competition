# üéì Student Differentiation - Implementation Strategy

## üéØ Objective

Redesign the way students (participants) are handled in the competition management system to ensure:

- Accurate student identification across multiple competitions and school years
- Support for resolving potential name conflicts when multiple students have the same name
- A flexible structure for searching and querying students and their competition history

## üß± Data Model

### `Student` Model

Represents a logical student entity (e.g., "L√°szl√≥ Bodri").

```csharp
public class Student
{
    public int Id { get; set; }
    public string FirstName { get; set; } = "";
    public string LastName { get; set; } = "";
    public ICollection<CompetitionParticipant> CompetitionParticipants { get; set; } = new List<CompetitionParticipant>();
}
```

### `CompetitionParticipant` Model

Represents a student's participation in a competition, including contextual information like grade, class, and school year. A single `Student` can have many `CompetitionParticipant` entries.

```csharp
public class CompetitionParticipant
{
    public int Id { get; set; }

    public int StudentId { get; set; }
    public Student Student { get; set; } = null!;

    public int CompetitionId { get; set; }
    public Competition Competition { get; set; } = null!;

    public int ClassYear { get; set; }           // E.g. 10, 11, 12
    public string ClassLetter { get; set; } = ""; // E.g. "B", "C"
    public int SchoolYear { get; set; }          // E.g. 2000 for school year 2000/2001
    
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
    public DateTime? UpdatedAt { get; set; }
}
```

> **Note**: `SchoolYear` is derived from the competition date (e.g., if competition is 2000-10-12 ‚Üí `SchoolYear = 2000`).

## üîç Student Matching Logic

When adding a participant to a competition:

1. Backend searches for any existing `Student` with the same first and last name.
2. For each match, it checks their existing `CompetitionParticipant` records for:
   - The same `SchoolYear`
   - The same `ClassYear` and `ClassLetter`
3. **If match found**:
   - Associate with existing student
4. **If no exact match, but same name exists**:
   - Return potential conflicts to frontend
   - Let frontend ask user to confirm: "Is this the same [Name] who was in [Class] in [Year]?"
   - Backend receives either:
     - `studentId` (reuse existing student)
     - or full name (create new student entry)

## üöÄ Implementation Plan

### Phase 1: Database & Backend (Week 1-2)

#### 1. Database Migrations
- [ ] Update `Students` table (if needed)
- [ ] Create `CompetitionParticipants` table with:
  - `StudentId` (FK to Students)
  - `CompetitionId` (FK to Competitions)
  - `ClassYear` (int)
  - `ClassLetter` (string)
  - `SchoolYear` (int, derived from competition date)
  - `CreatedAt` and `UpdatedAt` timestamps

#### 2. Backend Implementation

##### Models & DTOs
- [ ] Update `Student` model
- [ ] Create `CompetitionParticipant` model
- [ ] Create DTOs for:
  - `ParticipantDto` (for submission)
  - `ParticipantResponseDto` (for responses)
  - `StudentMatchDto` (for conflict resolution)

##### Services
- [ ] `StudentService`:
  - `FindPotentialMatches(firstName, lastName)`
  - `GetStudentParticipationHistory(studentId)`
- [ ] `CompetitionService`:
  - `AddParticipant(competitionId, participantDto)`
  - `ResolveParticipantConflict(competitionId, resolutionDto)`

##### API Endpoints
- [ ] `GET /api/students/match?firstName=&lastName=` - Find potential student matches
- [ ] `POST /api/competitions/{id}/participants` - Add participant (with conflict resolution)
- [ ] `GET /api/students/{id}/history` - Get student's competition history

### Phase 2: Frontend Implementation (Week 3)

- [ ] Update competition form to collect participant information
- [ ] Implement student search and selection
- [ ] Add conflict resolution UI
- [ ] Display participation history

### Phase 3: Testing & Refinement (Week 4)

- [ ] Unit tests for matching logic
- [ ] Integration tests for API endpoints
- [ ] End-to-end testing
- [ ] Performance testing with large datasets

## üõ°Ô∏è Data Integrity

Add database constraint to prevent duplicate class assignments in the same school year:

```sql
CREATE UNIQUE INDEX ux_student_participation_per_year
ON CompetitionParticipants (StudentId, SchoolYear);
```

## üìà Benefits

- Prevents accidental merging of different students with the same name
- Maintains clear history of each student's competition activity
- Enables flexible querying of student participation
- Supports accurate reporting and analytics

## üìù Notes

- Use string enums in the database with `HasConversion<string>()`
- Store class information in separate fields (numeric grade + class letter)
- Implement proper error handling for duplicate entries
- Add comprehensive logging for audit purposes

### 3. Frontend Implementation

#### Services
- [ ] Create `StudentService` for API communication
- [ ] Update `CompetitionService` for participant management

#### Components
- [ ] `StudentSelectorComponent`
  - Search and select existing students
  - Option to create new student
  - Display selected students

- [ ] `StudentFormComponent`
  - Form for creating/editing students
  - Validation for required fields
  - Error handling

- [ ] `StudentListComponent`
  - Display list of students
  - Filtering and sorting
  - Pagination support

#### Competition Module Updates
- [ ] Update competition form to use new student selection
- [ ] Add modal for adding new students
- [ ] Display participant class information

### 4. Testing
- [ ] Unit tests for backend services
- [ ] Integration tests for API endpoints
- [ ] E2E tests for critical user flows
- [ ] UI component tests

### 5. Documentation
- [ ] Update API documentation
- [ ] Add user guide for new features
- [ ] Document database schema changes

## API Design

### Student Search
```http
GET /api/students/search?query=John+Doe&limit=5
```

**Response:**
```json
{
  "matches": [
    {
      "id": 1,
      "firstName": "John",
      "lastName": "Doe",
      "recentParticipations": [
        {
          "competitionName": "Math Olympiad 2024",
          "classYear": 10,
          "classLetter": "B",
          "schoolYear": 2024
        }
      ]
    }
  ]
}
```

### Check for Potential Conflicts
```http
POST /api/competitions/{competitionId}/participants/check-conflicts
```

**Request:**
```json
{
  "participants": [
    {
      "firstName": "John",
      "lastName": "Doe",
      "classYear": 11,
      "classLetter": "A"
    }
  ]
}
```

**Response (if conflicts exist):**
```json
{
  "hasConflicts": true,
  "conflicts": [
    {
      "proposed": {
        "firstName": "John",
        "lastName": "Doe",
        "classYear": 11,
        "classLetter": "A"
      },
      "existingStudents": [
        {
          "id": 1,
          "firstName": "John",
          "lastName": "Doe",
          "recentParticipations": [
            {
              "competitionName": "Math Olympiad 2024",
              "classYear": 10,
              "classLetter": "B",
              "schoolYear": 2024
            }
          ]
        }
      ]
    }
  ]
}
```

### Add Participants to Competition
```http
POST /api/competitions/{competitionId}/participants
```

**Request:**
```json
{
  "participants": [
    {
      "studentId": 1,  
      "classYear": 11,
      "classLetter": "A"
    },
    {
      "firstName": "Jane", 
      "lastName": "Smith",
      "classYear": 10,
      "classLetter": "B"
    }
  ]
}
```

### Get Student Competition History
```http
GET /api/students/{id}/history
```

**Response:**
```json
{
  "student": {
    "id": 1,
    "firstName": "John",
    "lastName": "Doe"
  },
  "participations": [
    {
      "competitionId": 5,
      "competitionName": "Math Olympiad 2024",
      "date": "2024-03-15T00:00:00",
      "classYear": 10,
      "classLetter": "B",
      "schoolYear": 2024
    }
  ]
}
```

### Phase 1: Database & Backend (Week 1-2)

#### 0. Database Migrations
- [ ] Create `CompetitionParticipants` table with:
  - `Id` (PK)
  - `StudentId` (FK to Students)
  - `CompetitionId` (FK to Competitions)
  - `ClassYear` (int)
  - `ClassLetter` (string)
  - `SchoolYear` (int, derived from competition date)
  - `CreatedAt` and `UpdatedAt` timestamps
  
```sql
  CREATE UNIQUE INDEX ux_student_participation_per_year
  ON CompetitionParticipants (StudentId, SchoolYear);
  ```

#### 1. Core Services
- [ ] `IStudentService`
  - `Task<StudentSearchResult> SearchStudentsAsync(string query, int limit = 5)`
  - `Task<StudentParticipationHistory> GetStudentHistoryAsync(int studentId)`
  
- [ ] `ICompetitionService`
  - `Task<ParticipantConflictCheckResult> CheckForConflictsAsync(int competitionId, IEnumerable<ParticipantDto> participants)`
  - `Task AddParticipantsAsync(int competitionId, IEnumerable<ParticipantDto> participants)`
  - `Task<IEnumerable<CompetitionParticipant>> GetCompetitionParticipantsAsync(int competitionId)`

#### 2. API Controllers
- [ ] `StudentsController`
  - `GET /api/students/search` - Search students by name
  - `GET /api/students/{id}/history` - Get student's competition history
  
- [ ] `CompetitionParticipantsController`
  - `POST /api/competitions/{id}/participants/check-conflicts` - Check for potential conflicts
  - `POST /api/competitions/{id}/participants` - Add participants to competition
  - `GET /api/competitions/{id}/participants` - List competition participants

## Database Changes

### 1. Student Table Update
- Add new columns:
  - `first_name` (VARCHAR)
  - `last_name` (VARCHAR)

### 2. Competition Student Junction Table Update
- Rename from `competition_student` to `competition_participants`
- Add columns:
  - `class_year` (INTEGER)
  - `class_letter` (VARCHAR(1))
  - `created_at` (TIMESTAMP)
  - `updated_at` (TIMESTAMP)

## Backend Changes

### 1. Models
- Update `Student` model to include new fields
- Update `CompetitionStudent` model to include class information

### 2. DTOs
- Create/Update DTOs for student operations:
  - `CreateStudentDto`
  - `UpdateStudentDto`
  - `StudentResponseDto`
  - `CompetitionParticipantDto`

### 3. New Endpoints

#### Students
- `GET /api/students` - List all students with filtering options
- `POST /api/students` - Create a new student
- `GET /api/students/search` - Search students by name/class
- `GET /api/students/:id` - Get student details

### 4. Updated Endpoints
- Update competition endpoints to handle class information when adding participants

## Frontend Changes

### 1. Student Management
- Create new components:
  - `student-selector` - For searching/selecting existing students
  - `student-form` - For creating/editing student information
  - `student-list` - For displaying students with filtering options

### 2. Competition Management
- Update competition form to include student selection
- Add modal for adding new students
- Include class information when adding participants

### 3. UI/UX
- Add form validation for student information
- Implement autocomplete for student selection
- Show clear feedback for successful/failed operations

## Implementation Phases

### Phase 1: Database & Core Backend (Week 1)
- [ ] Database migrations
- [ ] Core model updates
- [ ] Basic CRUD endpoints for students
- [ ] Basic student search functionality

### Phase 2: Competition Integration (Week 2)
- [ ] Update competition participant logic
- [ ] Add class information to participation
- [ ] Implement participant management endpoints
- [ ] Add validation and error handling

### Phase 3: Frontend Implementation (Week 3)
- [ ] Student management components
- [ ] Competition form updates
- [ ] Student selection modal
- [ ] Form validation and error handling

### Phase 4: Testing & Refinement (Week 4)
- [ ] Unit and integration tests
- [ ] E2E testing
- [ ] Performance optimization
- [ ] User acceptance testing
- [ ] Documentation updates

## Potential Challenges
1. Data migration for existing student records
2. Handling duplicate student names
3. Performance with large student lists
4. Maintaining data consistency

## Future Considerations
1. Add student photos for easier identification
2. Implement bulk import/export of student data
3. Add more detailed student information (date of birth, contact info)
4. Implement student search with advanced filters
